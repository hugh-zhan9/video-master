# Video Master 代码审查记录（2026-02-13）

## 1. 需求理解（基于当前实现）
当前代码实现的核心需求可以概括为：
1. 扫描目录导入视频，支持递归、格式过滤、增量处理。
2. 视频列表支持分页加载、关键词搜索、标签筛选、随机播放。
3. 标签管理支持增删改、与视频多对多关联。
4. 设置支持删除策略、自动扫描、日志开关、扩展名配置、目录配置。
5. 启动时可按配置自动增量扫描目录，并在 UI 中展示扫描进度。

本次审查重点是“需求落地正确性 + 行为一致性 + 回归风险”。

---

## 2. 审查范围
- 后端：`main.go`、`app.go`、`database/database.go`、`models/video.go`、`services/*.go`
- 前端：`frontend/src/App.vue`、`frontend/src/main.js`、`frontend/src/style.css`
- 绑定：`frontend/wailsjs/go/main/App.js`、`frontend/wailsjs/go/main/App.d.ts`
- 测试：`services/video_service_test.go`

---

## 3. 主要问题清单（按严重级别排序）

### S1-高：播放失败仍然累计播放次数，统计口径被污染
- 位置：`services/video_service.go:278`、`services/video_service.go:371`
- 现象：`PlayVideo`/`PlayRandomVideo` 在调用系统播放器前就更新计数；若 `openWithDefault` 失败，计数已落库。
- 影响：
  1. 播放次数与真实成功播放不一致。
  2. 随机推荐权重被错误放大，长期影响分发结果。
- 建议：将计数更新移动到“打开成功后”；或新增 `play_attempt_count` 与 `play_success_count` 双指标，区分尝试与成功。

### S1-高：自动增量扫描对“子目录历史记录”无法完整对账
- 位置：`services/video_service.go:255`、`frontend/src/App.vue:88`
- 现象：前端增量对账依赖 `GetVideosByDirectory(dir)`，后端仅 `WHERE directory = ?`，只覆盖根目录，不覆盖其子目录记录。
- 影响：
  1. 配置目录下子目录的“文件已删除但记录残留”无法被清理。
  2. 扫描时会出现额外 `AddVideo` 冲突/跳过，造成噪音与性能损耗。
- 建议：查询改为目录前缀匹配（如 `directory = ? OR directory LIKE ?`），并统一路径规范后做集合对账。

### S2-中：搜索/筛选模式固定上限 200 条，存在结果截断
- 位置：`frontend/src/App.vue:503`
- 现象：组合搜索调用 `SearchVideosWithFilters(..., limit=200)` 后直接 `hasMore=false`。
- 影响：大量数据场景下用户看不到 200 条之后的匹配项，属于静默截断。
- 建议：复用游标分页机制到搜索模式，或明确展示“已截断到前 200 条”。

### S2-中：日志开关反复切换可能导致文件句柄累积
- 位置：`app.go:43`
- 现象：每次启用日志都 `os.OpenFile` 并 `log.SetOutput(f)`，未关闭旧句柄。
- 影响：频繁切换设置时可能产生句柄泄漏（长会话更明显）。
- 建议：在 `App` 结构中持有当前日志文件句柄，切换时先 `Close` 再替换。

### S3-低：历史兼容路径变量未真正区分，代码意图与实现不一致
- 位置：`database/database.go:24`、`app.go:49`
- 现象：`dataDir` 与 `legacyDir` 均为 `~/.video-master`，兼容分支实际无效。
- 影响：可读性下降，后续维护者容易误判迁移逻辑。
- 建议：要么恢复真实“新旧目录差异”，要么删除兼容分支，保持单一真实路径。

---

## 4. 与需求的一致性结论

### 已满足（本轮代码可见）
1. 名称搜索 + 标签筛选已改为组合关系。  
2. 隐藏文件/目录（以 `.` 开头）已被扫描层过滤。  
3. 随机播放失败信息已包含具体视频名和路径。  
4. 通过唯一索引 + 启动清理机制，重复路径记录得到约束。  

### 仍有偏差/风险
1. “启动增量扫描自动对账”在子目录维度仍不完整（见 S1）。  
2. “播放次数统计准确性”在播放失败场景不成立（见 S1）。  
3. “搜索结果完整性”在大数据集下不成立（见 S2）。

---

## 5. 测试与覆盖评估
- 现有测试覆盖了：
  1. 隐藏文件过滤。
  2. 组合搜索行为。
  3. 随机播放失败错误上下文。
  4. 路径唯一约束。
- 主要缺口：
  1. 自动增量扫描“目录树对账”端到端测试缺失。
  2. 播放失败计数不应变化的回归测试缺失。
  3. 搜索分页/截断行为缺少契约测试。

---

## 6. 超出当前框架的优化建议（架构级）
1. 将“扫描 + 对账”下沉到后端单事务服务（前端只订阅进度事件），避免前端持有数据库一致性逻辑。  
2. 为视频记录引入 `file_fingerprint`（如 size + mtime + hash）用于重命名识别，降低路径变化导致的误删误增。  
3. 为扫描任务增加 `scan_jobs` 表（任务状态、统计、错误明细），支撑可追踪与重试。

---

## 7. 审查结论
当前实现整体可用，且已覆盖你提出的多数修复诉求；但仍存在 2 个高优先级行为偏差（播放计数时机、子目录对账范围）。建议优先修复 S1 项，再处理 S2 的搜索分页体验。
