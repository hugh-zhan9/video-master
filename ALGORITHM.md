# 智能随机播放算法说明

## 算法目标
实现一个智能的随机播放算法，使得：
1. 被播放过的视频下次被选中的概率降低
2. 尽量平衡所有视频的播放次数
3. 普通播放和随机播放有不同的权重影响

## 核心思想

### 1. 播放分数计算
每个视频有一个"播放分数"，计算公式为：
```
播放分数 = 普通播放次数 × 播放权重 + 随机播放次数
```

其中：
- `普通播放次数(play_count)`: 用户主动点击播放的次数
- `随机播放次数(random_play_count)`: 随机播放被选中的次数
- `播放权重(play_weight)`: 可配置参数，默认为 2.0

**示例**：
- 如果权重为 2.0，那么 1 次普通播放 = 2 次随机播放
- 视频A: play_count=1, random_play_count=0 → 分数=2.0
- 视频B: play_count=0, random_play_count=2 → 分数=2.0
- 视频C: play_count=0, random_play_count=0 → 分数=0.0

### 2. 选择概率计算
分数越低的视频，被选中的概率越高。具体步骤：

1. **计算所有视频的播放分数**
2. **找出最大分数**：`max_score`
3. **计算每个视频的选择权重**：
   ```
   选择权重 = max_score - 播放分数 + 1
   ```
   每个视频独立计算权重，数量会自然影响整体概率

4. **加权随机选择**：
   - 计算总权重：`total_weight = sum(所有选择权重)`
   - 生成随机数：`random_value = random(0, total_weight)`
   - 累加权重找到对应视频

### 3. 算法特性

#### 均衡性
- 未播放的视频（分数=0）有最高的被选中概率
- 当所有视频分数相同时，所有视频被选中概率相等
- 分数差异越大，选中概率差异越大
- **同分数组数量越多，会自然提高该分数段的总体概率，但单个视频的概率会下降**

#### 渐进性
- 随着播放次数增加，分数逐渐提高
- 不会完全排除已播放的视频，只是降低概率
- 最终会趋向于所有视频播放次数平衡

#### 可配置性
- 通过调整 `play_weight` 可以控制普通播放的影响程度
- 权重越高，普通播放对分数的影响越大

## 算法实现示例

假设有 4 个视频，play_weight = 2.0：

| 视频 | play_count | random_play_count | 播放分数 | 选择权重 | 选中概率 |
|------|-----------|-------------------|---------|---------|---------|
| A    | 0         | 0                 | 0       | 5       | 29.41%  |
| B    | 0         | 1                 | 1       | 4       | 23.53%  |
| C    | 1         | 0                 | 2       | 3       | 17.65%  |
| D    | 2         | 0                 | 4       | 1       | 5.88%   |
| E    | 0         | 0                 | 0       | 5       | 29.41%  |

max_score = 4, total_weight = 5+5+4+3+1 = 18

可以看到：
- 从未播放的视频A/E（分数0）有最高概率
- 播放次数最多的视频D（分数4）最低概率
- 同分数组数量增加，总体概率上升，但单个视频仍有较低概率

## 边界情况处理

### 情况1：所有视频从未播放
- 所有分数为0，权重相同
- 等概率随机选择

### 情况2：所有视频播放次数相同
- 所有分数相同，权重相同
- 等概率随机选择

### 情况3：只有一个视频
- 必然选中该视频

### 情况4：数据库为空
- 返回错误："没有可播放的视频"

## 权重配置建议

| play_weight | 含义 | 适用场景 |
|------------|------|---------|
| 1.0 | 普通播放 = 随机播放 | 不区分播放方式 |
| 2.0 | 普通播放 = 2×随机播放 | 默认配置，平衡推荐 |
| 3.0 | 普通播放 = 3×随机播放 | 强化用户主动选择的影响 |
| 0.5 | 普通播放 = 0.5×随机播放 | 更关注随机播放历史 |

## 实时生效

权重配置修改后立即生效，下次随机播放时使用新权重计算。
