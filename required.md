# 视频管理器 - 需求文档

## 项目概述
一个基于 Golang + Wails 开发的桌面视频管理应用（Video Master），支持视频扫描、标签管理、搜索筛选、播放等功能。

---

## 功能需求

### 1. 核心功能

#### 1.1 视频扫描
- [x] 扫描指定目录下的所有视频文件
- [x] 支持递归扫描子目录（包括所有子文件夹）
- [x] 支持多种视频格式（见 1.8）
- [x] 自动导入视频到数据库
- [x] 显示扫描进度（已发现/已导入）
- [x] 支持增量扫描（已存在视频自动跳过）

#### 1.2 视频列表展示
- [x] 列表形式展示所有视频
- [x] 显示视频名称、路径、标签
- [x] 显示视频文件大小（M/G 格式）
- [x] 支持空状态提示
- [x] **分页查询（游标方式）**
- [x] **无限滚动加载**
- [x] 按随机播放概率排序（概率高的在前）
- [x] 概率相同按文件大小排序
- [x] 路径显示支持目录别名

#### 1.3 搜索功能
- [x] 按文件名关键词模糊搜索
- [x] 实时搜索（输入即搜）
- [x] 支持按标签筛选
- [x] 搜索和标签筛选可组合使用
- [x] 标签筛选支持多选组合（AND）

#### 1.4 标签管理
- [x] 创建标签（名称 + 颜色）
- [x] 编辑标签（名称 + 颜色）
- [x] 删除标签
- [x] 顶部标签筛选支持删除标签（并移除所有关联）
- [x] 标签已存在时提示用户
- [x] 为视频添加标签
- [x] 从视频移除标签
- [x] **支持手动输入新标签并自动创建**
- [x] 标签筛选（点击标签查看相关视频）
- [x] 一个视频支持多个标签

#### 1.5 视频操作
- [x] 使用系统默认播放器播放视频
- [x] 打开视频所在目录
- [x] 删除视频记录
- [x] 可选择是否删除原始文件
- [x] 右键菜单快捷操作
- [ ] **记录播放次数**
- [ ] **记录随机播放次数**
- [ ] **随机播放功能**

#### 1.6 删除确认
- [x] 删除前弹出确认对话框
- [x] 可选择是否同时删除原始文件
- [x] 支持"不再提醒"选项
- [x] 删除偏好设置持久化

#### 1.7 右键菜单
- [x] 播放视频
- [x] 打开文件所在目录
- [x] 删除视频

#### 1.8 视频格式支持
- [x] 默认支持多种常见格式
  - 基础格式：.mp4, .avi, .mkv, .mov, .wmv, .flv, .webm, .m4v, .qt
  - 扩展格式：.ts, .3gp, .mpg, .mpeg, .rm, .rmvb, .vob, .divx, .f4v, .asf
- [x] **支持用户自定义格式列表**

#### 1.9 字幕生成 (新增)
- [ ] 离线生成视频字幕 (Whisper.cpp)
- [ ] 自动下载依赖环境 (FFmpeg + Model)
- [ ] 实时显示生成进度

### 2. 设置功能

#### 2.1 基本设置
- [x] 删除前确认开关
- [x] 默认删除原始文件开关
- [x] 启动时自动增量扫描配置目录
- [x] 启动自动扫描为异步，不阻塞界面
- [x] 日志记录开关（未开启时不写日志）

#### 2.2 视频格式配置
- [x] 自定义支持的视频格式
- [x] 格式列表以逗号分隔
- [x] 实时生效（保存后下次扫描生效）

#### 2.3 扫描目录管理
- [x] 添加扫描目录
- [x] 为目录设置别名
- [x] 编辑目录配置
- [x] 删除目录配置
- [x] 支持多个扫描目录

#### 2.4 智能随机播放配置
- [x] 播放权重配置（1次普通播放 = N次随机播放）
- [x] 支持小数点设置（如 2.5）
- [x] 实时生效（保存后立即应用于随机播放）
- [x] 提供配置建议和说明

### 3. 界面设计

#### 3.1 页面结构
- [x] 顶部导航栏
  - [x] 应用标题
  - [x] 页面切换按钮（视频列表/设置）
- [x] 视频列表页
  - [x] 工具栏（搜索框、扫描按钮、标签管理按钮）
  - [x] 标签筛选栏
  - [x] 视频列表
- [x] 设置页
  - [x] 基本设置
  - [x] 格式配置
  - [x] 目录管理

#### 3.2 交互优化
- [x] 悬停效果
- [x] 点击反馈
- [x] 加载状态显示
- [x] 错误提示
- [x] 成功提示

### 4. 数据管理

#### 4.1 数据库
- [x] 使用 SQLite 内嵌数据库
- [x] 数据存储在用户目录 `~/.video-master/`
- [x] 自动创建和迁移数据表

#### 4.2 数据模型
- [x] Video（视频）
  - ID、名称、路径、目录、大小、时长
  - 创建时间、更新时间
  - [x] **播放次数**
  - [x] **随机播放次数**
  - [x] **最后播放时间**
- [x] Tag（标签）
  - ID、名称、颜色
  - 多对多关系（video_tags）
- [x] Settings（设置）
  - 删除确认、默认删除文件
  - 视频格式列表
  - [x] **播放权重配置**
- [x] ScanDirectory（扫描目录）
  - 路径、别名

#### 4.3 性能优化
- [x] **游标分页查询**
- [x] **无限滚动加载**
- [ ] **批量操作优化**
- [ ] **索引优化**

#### 4.4 智能算法
- [x] **加权随机播放算法**
  - 基于播放历史的智能推荐
  - 自动平衡视频播放次数
  - 数量自然影响整体概率，单个视频仍按分数权重衰减
  - 可配置权重参数
  - 详见 `ALGORITHM.md`

---

## 技术规格

### 后端技术栈
- **语言**: Go 1.18+
- **框架**: Wails v2
- **ORM**: GORM
- **数据库**: SQLite

### 前端技术栈
- **框架**: Vue 3
- **构建工具**: Vite
- **语言**: JavaScript

### 跨平台支持
- [x] macOS
- [x] Windows
- [x] Linux

---

## 待实现功能

### 高优先级
无

### 中优先级
- [ ] 视频时长获取（使用 ffmpeg）
- [ ] 视频缩略图生成
- [ ] 批量操作（批量删除、批量打标签）
- [ ] 导入/导出配置

### 低优先级
- [ ] 视频收藏功能
- [ ] 播放历史记录界面
- [ ] 数据统计图表
- [ ] 暗色模式

---

## 变更记录

### 2026-02-12 (第二次更新)
- ✅ 实现游标分页查询（提升大数据量性能）
- ✅ 实现无限滚动加载
- ✅ 实现随机播放功能
- ✅ 实现播放次数统计
- ✅ **实现智能加权随机播放算法**
  - 基于播放历史的智能推荐
  - 自动平衡视频播放次数
  - 同分数组共享概率，避免数量过多导致分布失衡
  - 支持播放权重配置
  - 实时生效，无需重启
- ✅ 支持增量扫描（自动跳过已存在视频）
- ✅ 启动时自动增量扫描配置目录
- ✅ 启动自动扫描改为异步，不阻塞界面
- ✅ 列表按随机播放概率排序，概率相同按文件大小排序

### 2026-02-12 (第一次更新)
- ✅ 初始项目创建
- ✅ 实现视频扫描功能
- ✅ 实现标签管理功能
- ✅ 实现搜索和筛选功能
- ✅ 添加设置页面
- ✅ 支持自定义视频格式
- ✅ 支持扫描目录别名管理
- ✅ 优化添加标签界面（支持手动输入）

---

## 备注

### 数据安全
- 删除操作提供二次确认
- 支持仅删除记录而保留文件
- 数据库文件可手动备份

### 日志
- 运行日志写入 `~/.video-master/app.log`
- 前端调用的接口名称与结果会写入日志
- 日志开关关闭时不写入文件

### 性能考虑
- 大数据量场景下使用游标分页
- 避免一次性加载所有数据
- 优化数据库查询索引

### 用户体验
- 开箱即用，无需额外配置
- 清晰的操作反馈
- 友好的错误提示
